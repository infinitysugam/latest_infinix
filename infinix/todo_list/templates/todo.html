{% extends "all_base.html" %}  
{% block content %}

<style>
    /* Your existing CSS styles */
    body {
       /* background: linear-gradient(to right,#021124,#996633); /* Set the background color here */
       background:#996633
    }
</style>



<button id="createNoteButton" class = "button-74">New Sticky Note</button>
<button id="createnotebookButton" class = "button-74">New Notebook</button>


<ul class = 'note-ul'>
{% for task in tasks %}
{% if task.category_id == 1 %}
<li class="note-li" data-task-id = "{{ task.id }}">
        <button class="delete-button" onclick="deleteTask('{{ task.id }}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
          </svg></button>
    <h2 class='note-h2' contenteditable="false">{{ task.title }} </h2>
    <p class="note-p" contenteditable="false">{{ task.description }}</p>
</li>
{% else %}
<div class="notebook-paper" data-task-id = "{{ task.id }}">
    <button class="delete-button" onclick="deleteTask('{{ task.id }}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
      </svg></button>
    <div class="notebook-lines">
    <!-- <div class='notebook-title' contenteditable="false">{{ task.title }} </div> -->
        <div class='notebook-desc' contenteditable="false" contenteditable spellcheck="false">{{ task.description }}</div>
    
</div>
<div class="holes notebook-hole-top"></div>
<div class="holes notebook-hole-middle"></div>
<div class="holes notebook-hole-bottom"></div>   
</div>  


{% endif %}
{% empty %} 
<li class ='note-li'>No tasks yet.</li>
{% endfor %}
</ul>

<script>
  // Get CSRF token value from Django template
  var csrftoken = '{ %csrf_token% }'; 
    // Add event listener to enable editing
    document.querySelectorAll('.note-li').forEach(function(item) {
        item.addEventListener('click', enableEditing);
    });


    document.querySelectorAll('.notebook-paper').forEach(function(item) {
        item.addEventListener('click', enableEditingnotebook);
    });


    function enableEditingnotebook(event) {
        var target = event.currentTarget;
        var taskId = target.dataset.taskId;
        // var titleElement = target.querySelector('.notebook-title');
        var descriptionElement = target.querySelector('.notebook-desc');

       

        // titleElement.contentEditable = true;
        descriptionElement.contentEditable = true;

  

        // // Add event listener to save changes
        // titleElement.addEventListener('blur', function() {
        //     saveChanges(taskId, 'title', titleElement.textContent);


        //     resizeNotebook(titleElement);
        // resizeNotebook(descriptionElement);
        // });

        descriptionElement.addEventListener('blur', function() {
            saveChanges(taskId, 'description', descriptionElement.textContent);
        });
    }




    function enableEditing(event) {
        var target = event.currentTarget;
        var taskId = target.dataset.taskId;
        var titleElement = target.querySelector('.note-h2');
        var descriptionElement = target.querySelector('.note-p');

       

        titleElement.contentEditable = true;
        descriptionElement.contentEditable = true;

  

        // Add event listener to save changes
        titleElement.addEventListener('blur', function() {
            saveChanges(taskId, 'title', titleElement.textContent);


            resizeNotebook(titleElement);
        resizeNotebook(descriptionElement);
        });

        descriptionElement.addEventListener('blur', function() {
            saveChanges(taskId, 'description', descriptionElement.textContent);
        });
    }

    function saveChanges(taskId, field, value) {

        console.log("updating task with id",taskId,"field",field,"with value",value)

        // Send AJAX request to update task in the database
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'update/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', csrftoken);
        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log('Task updated successfully');
            } else {
                console.error('Error updating task:', xhr.responseText);
            }
        };
        xhr.send(JSON.stringify({
            'task_id': taskId,
            'field': field,
            'value': value
        }));
    }

    document.getElementById('createNoteButton').addEventListener('click', function() {
        // Send AJAX request to create a new task
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'add/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', csrftoken); // Include CSRF token in request headers
        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log('Note created successfully');
                location.reload();
                // Optionally, provide feedback to the user
                // For example: display a success message
                // Then, update the UI to show the new note
                var newTask = JSON.parse(xhr.responseText);
                addNewTaskToUI(newTask);
            } else {
                console.error('Error creating note:', xhr.responseText);
                // Optionally, provide feedback to the user
                // For example: display an error message
            }
        };
        xhr.send(JSON.stringify({'category_id':1}));
    });

    document.getElementById('createnotebookButton').addEventListener('click', function() {
        // Send AJAX request to create a new task
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'add/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', csrftoken); // Include CSRF token in request headers
        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log('Note created successfully');
                location.reload();
                // Optionally, provide feedback to the user
                // For example: display a success message
                // Then, update the UI to show the new note
                var newTask = JSON.parse(xhr.responseText);
                addNewTaskToUI(newTask);
            } else {
                console.error('Error creating note:', xhr.responseText);
                // Optionally, provide feedback to the user
                // For example: display an error message
            }
        };
        xhr.send(JSON.stringify({'category_id': 2}));
    });




    function resizeNotebook(element) {
    var maxHeight = 200; // Maximum height for the element
    element.style.height = 'auto'; // Reset height
    if (element.scrollHeight > maxHeight) {
        element.style.height = maxHeight + 'px';
    } else {
        element.style.height = element.scrollHeight + 'px';
    }
}

// document.addEventListener('DOMContentLoaded', function() {
//     var plusButton = document.getElementById('plusButton');
//     var dropdownButtons = document.getElementById('dropdownButtons');

//     plusButton.addEventListener('click', function() {
//         dropdownButtons.classList.toggle('hidden');
//     });
// });

function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this note?')) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'delete/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log('Note deleted successfully');
                    location.reload();
                } else {
                    console.error('Error deleting note:', xhr.responseText);
                }
            };
            xhr.send(JSON.stringify({'task_id': taskId}));
        }
    }
</script>
{% endblock %}